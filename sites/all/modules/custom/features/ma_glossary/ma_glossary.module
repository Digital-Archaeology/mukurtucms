<?php
/**
 * @file
 * Code for the Mukurtu Glossary feature.
 */

include_once 'ma_glossary.features.inc';

function ma_glossary_menu() {
  $items['node/%node/add-term'] = array(
    'title' => 'Add New Glossary Term',
    'page callback' => 'ma_glossary_add_glossary_term',
    'page arguments' => array(1),
    'access callback' => 'ma_glossary_add_glossary_term_check',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 100,
  );

  return $items;
}

function ma_glossary_add_glossary_term($node) {
  drupal_goto ('node/add/glossary-term/' . $node->nid);
}

function ma_glossary_add_glossary_term_check($node) {
  if($node->type == 'glossary') {
    return TRUE;
  }

  return FALSE;
}

function ma_glossary_form_glossary_term_node_form_alter(&$form, &$form_state) {
  if(arg(2) == 'glossary-term') {
    if(arg(3) && $glossary_node = node_load(arg(3))) {
      drupal_set_title(t("Create Glossary Term in ") . $glossary_node->title);
      node_save($glossary_node);
    }
  }
}

function ma_glossary_node_insert($node) {
  if($node->type == 'glossary_term') {
    // Add new glossary term to glossary, if one was specified
    if(arg(3) && $glossary_node = node_load(arg(3))) {
      if($glossary_node->type == 'glossary') {
	$glossary_node->field_glossary_terms[LANGUAGE_NONE][]['target_id'] = $node->nid;
	node_save($glossary_node);
	drupal_goto(drupal_get_path_alias('node/' . $glossary_node->nid));
      }
    }
  }
}

function ma_glossary_node_view($node, $view_mode) {
  if($node->type == 'glossary') {
    if($view_mode == 'full') {
      foreach($node->content['field_glossary_terms']['#items'] as $key => $target_id) {
	$node->content['field_glossary_terms'][$key]['#markup'] = "";
      }
      
      $glossary_content = views_embed_view('mukurtu_glossary', 'page_mukurtu_glossaries', $node->nid);
      $node->content['field_glossary_terms'][0]['#markup'] = $glossary_content;
    }
  }
}

function ma_glossary_views_pre_render(&$view) {
  //  dpm($view);

  if($view->name == 'mukurtu_glossary' && $view->is_attachment == FALSE) {
    if(isset($view->args)) {
      $node = node_load($view->args[0]);
      if($node) {
	//	dpm($node);
  	//$view->set_title($node->field_glossary_source[LANGUAGE_NONE][0]['value']);
	$view->set_title($node->title);
      }
    }
  }
}