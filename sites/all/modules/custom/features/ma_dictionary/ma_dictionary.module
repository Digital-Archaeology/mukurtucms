<?php
/**
 * @file
 * Code for the Mukurtu Dictionary feature.
 */

include_once 'ma_dictionary.features.inc';

function ma_dictionary_menu() {

    // Form to set default language
    $items['dashboard/set-default-language'] = array(
      'title' => 'Set Default Language',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ma_dictionary_set_default_language'),
      'access arguments' => array('administer taxonomy'),
    );
    return $items;
}

function ma_dictionary_set_default_language() {
    $language = taxonomy_vocabulary_machine_name_load('language');
    $terms = taxonomy_get_tree($language->vid);

    foreach ($terms as $term) {
        $options[$term->tid] = $term->name;
    }

    $form['default_language'] = array (
      '#type' => 'radios',
      '#title' => 'Select the default language used when creating dictionary words',
      '#default_value' => variable_get ('mukurtu_default_language'),
      '#options' => $options,
    );

    $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Submit'),
    );

    return $form;
}

function ma_dictionary_set_default_language_submit ($form, &$form_state) {
    if ($tid = $form_state['values']['default_language']) {
        variable_set ('mukurtu_default_language', $tid);
        $term = taxonomy_term_load($tid);
        drupal_set_message('Default language set to <i>' . $term->name . '</i>.');
    }
    drupal_goto ('dashboard');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ma_dictionary_form_dictionary_word_node_form_alter(&$form, &$form_state) {

  // "Item Sharing Settings" field customizations versus how it works by default (as used in the DH node form)
  $form['field_item_privacy_setting'][LANGUAGE_NONE]['#required'] = FALSE; // not required for Dictionary Words
  if (!$form['field_item_privacy_setting'][LANGUAGE_NONE]['#default_value']) {
    $form['field_item_privacy_setting'][LANGUAGE_NONE]['#default_value'] = 'all'; // the field has a default value. This is just to catch cases on demo sites where words were set already before this field was added
  }
  // TODO: use #states to only show the field when a protocol is selected

    // Actions to perform when adding (not editing) dictionary words
  if ($form['#action'] == '/node/add/dictionary-word') {

    // Set the default language, if one is defined
    $form['field_dictionary_word_language'][LANGUAGE_NONE]['#default_value'] = variable_get ('mukurtu_default_language');
  }

}

/**
 * Implements template_preprocess_views_view.
 */
function ma_dictionary_preprocess_views_view(&$vars) {
  $view = &$vars['view'];

  // Add JS for browse mode switcher on Dictionary view
  if ($view->name == 'dictionary_words') {
    drupal_add_library('system', 'jquery.cookie');
    drupal_add_js(drupal_get_path('module', 'ma_dictionary') . '/js/dictionary_browse_mode_switcher.js');
  }

}

/**
 * Implements hook_url_outbound_alter
 */
// For the title (first letter) facet, restrict to one letter (or digit, or non-letter) at a time.
// Interestingly, this cannot be done in the facet config, by whatever combo of Operator and "Limit to one active item"

function ma_dictionary_url_outbound_alter(&$path, &$options, $original_path) {
  if (substr($path, 0, 11) == 'dictionary/') {
    if (substr_count($path, 'title') > 1) { // this catches first letter links adding to an existing first-letter-filtered URL
      $start_of_first_title = strpos ($path, '/title/');
      $end_of_first_title = strpos ($path, '/', $start_of_first_title + 8);
      $path = substr($path, 0, $start_of_first_title) . substr($path, $end_of_first_title); // strip out the first (ie. existing) title filter on the outbound link
    }
  }
}