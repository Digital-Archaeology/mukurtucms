<?php
/**
 * @file
 * Code for the Mukurtu Dictionary feature.
 */

include_once 'ma_dictionary.features.inc';

function ma_dictionary_menu() {

    // Form to set default language
    $items['dashboard/set-default-language'] = array(
      'title' => 'Set Default Language',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ma_dictionary_set_default_language'),
      'access arguments' => array('administer taxonomy'),
    );
    return $items;
}

function ma_dictionary_set_default_language() {
    $language = taxonomy_vocabulary_machine_name_load('language');
    $terms = taxonomy_get_tree($language->vid);

    foreach ($terms as $term) {
        $options[$term->tid] = $term->name;
    }

    $form['default_language'] = array (
      '#type' => 'radios',
      '#title' => 'Select the default language used when creating dictionary words',
      '#default_value' => variable_get ('mukurtu_default_language'),
      '#options' => $options,
    );

    $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Submit'),
    );

    return $form;
}

function ma_dictionary_set_default_language_submit ($form, &$form_state) {
    if ($tid = $form_state['values']['default_language']) {
        variable_set ('mukurtu_default_language', $tid);
        $term = taxonomy_term_load($tid);
        drupal_set_message('Default language set to <i>' . $term->name . '</i>.');
    }
    drupal_goto ('dashboard');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ma_dictionary_form_dictionary_word_node_form_alter(&$form, &$form_state) {

    // Actions to perform when adding (not editing) dictionary words
    if ($form['#action'] == '/node/add/dictionary-word') {

        // Set the default language, if one is defined
        $form['field_dictionary_word_language'][LANGUAGE_NONE]['#default_value'] = variable_get ('mukurtu_default_language');
    }
}

/**
 * Implements template_preprocess_views_view.
 */
function ma_dictionary_preprocess_views_view(&$vars) {
  $view = &$vars['view'];

  // Add JS for browse mode switcher on Dictionary view
  if ($view->name == 'dictionary_words') {
    drupal_add_library('system', 'jquery.cookie');
    drupal_add_js(drupal_get_path('module', 'ma_dictionary') . '/js/dictionary_browse_mode_switcher.js');
  }

}

